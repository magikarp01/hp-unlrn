import openai
from dotenv import load_dotenv
import os
import json

# Load environment variables from .env file
load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")
client = openai.OpenAI(
    organization="org-X6T6Ar6geRtOrQgQTQS3OUpw",
)


def augment_dataset(datapoints: list, model: str = "gpt-4-turbo-preview") -> list:
    """
    Augment a list of datapoints with one datapoint generated by the OpenAI API.

    :param datapoints: A list of dictionaries containing the existing datapoints.
    :param model: The OpenAI model to use for generation.
    :return: The augmented list of datapoints.
    """

    system_message = """
    You are a helpful assistant designed to output JSON. The following input contains a JSONL file with trivia questions about Harry Potter. I want you to augment the JSONL file with one new datapoint, maintaining the format of the existing input.
"""

    user_message = f"{datapoints}"

    messages = [
        {
            "role": "system",
            "content": system_message,
        },
        {
            "role": "user",
            "content": user_message,
        },
    ]

    response = (
        client.chat.completions.create(
            model=model,
            response_format={"type": "json_object"},
            messages=messages,
        )
        .choices[0]
        .message.content
    )

    new_datapoint = json.loads(response)
    datapoints.append(new_datapoint)

    return datapoints


if __name__ == "__main__":

    datapoints = []
    with open(
        "/ext_usb/Desktop/mats/hp-unlrn/aengus_testing/datasets/augmented_hp_2000_Jan29-2324-06.jsonl",
        "r",
    ) as f:
        for line in f:
            datapoints.append(json.loads(line))

    from datetime import datetime

    exp_time = datetime.now().strftime("%b%d-%H%M-%S")

    while len(datapoints) < 2000:
        print(f"\nlen(datapoints): {len(datapoints)}")
        print(f"datapoints[-1]: {datapoints[-1]}")

        datapoints = augment_dataset(datapoints)


        with open(
            "/ext_usb/Desktop/mats/hp-unlrn/aengus_testing/datasets/augmented_hp_2000_Jan29-2324-06.jsonl",
            "w",
        ) as f:
            for datapoint in datapoints:
                f.write(json.dumps(datapoint) + '\n')
        print(
            "Saved datapoints to /ext_usb/Desktop/mats/hp-unlrn/aengus_testing/datasets/augmented_hp_2000_Jan29-2324-06.jsonl"
        )
